<!DOCTYPE html>
<html lang="zh-cn" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>用户管理</title>


    <link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon" />
  </head>
  <body>
  <div th:replace="/layout/css :: #css"></div>
  <div id="main">
      <div id="toolbar">
          <a class="btn  btn-primary" href="javascript:;" onclick="createAction()"><i class="fa fa-plus-square"></i>新增</a>
          <a class="btn  btn-primary" href="javascript:;" onclick="toUpdate()"><i class="fa fa-pencil-square-o"></i>修改</a>
          <a class="btn  btn-primary" href="javascript:;" onclick="deleteAction()"><i class="fa fa-times-circle"></i>删除</a>
          <a class="btn  btn-primary" href="javascript:;" onclick=""><i class="fa fa-user-plus"></i>分配角色</a>
          <a class="btn  btn-primary" href="javascript:;" onclick=""><i class="fa fa-user-plus"></i>分配菜单</a>
      </div>
      <table id="table"></table>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="addModal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
          <div class="modal-content">
              <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                  <h4 class="modal-title">编辑用户</h4>
              </div>
              <div class="modal-body">
                  <form id="createForm" method="post" class="form-horizontal">
                      <input id="id" name="id" th:type="hidden" />
                      <div class="form-group">
                          <label for="username" class="col-sm-3 control-label">用户名</label>
                          <div class="col-sm-8">
                              <input id="username" name="username" type="text" class="form-control" />
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="password" class="col-sm-3 control-label">密码</label>
                          <div class="col-sm-8">
                              <input id="password" name="password" type="password" class="form-control" />
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="realname" class="col-sm-3 control-label">真实姓名</label>
                          <div class="col-sm-8">
                              <input id="realname" name="realname" type="text" class="form-control" />
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="phone" class="col-sm-3 control-label">电话</label>
                          <div class="col-sm-8">
                              <input id="phone" name="phone" type="text" class="form-control" />
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="email" class="col-sm-3 control-label">邮件</label>
                          <div class="col-sm-8">
                              <input id="email" name="email" type="text" class="form-control" />
                          </div>
                      </div>
                      <div class="form-group">
                          <label  class="col-sm-3 control-label">性别</label>
                          <div class="col-sm-8">
                              <div class="radio">
                                  <label class="radio-inline">
                                      <input type="radio" name="sex" value="1" checked="checked" />
                                      男
                                  </label>
                                  <label class="radio-inline">
                                      <input type="radio" name="sex" value="0" />
                                      女
                                  </label>
                              </div>
                          </div>
                      </div>
                      <div class="form-group">
                          <label  class="col-sm-3 control-label">状态</label>
                          <div class="col-sm-8">
                              <div class="radio">
                                  <label class="radio-inline">
                                      <input type="radio" name="locked" value="0" checked="checked" />
                                      正常
                                  </label>
                                  <label class="radio-inline">
                                      <input type="radio" name="locked" value="1" />
                                      锁定
                                  </label>
                              </div>
                          </div>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                  <button type="button" class="btn btn-primary" onclick="doCreate()">提交</button>
              </div>
          </div>
      </div>
  </div>
<div th:replace="/layout/js :: #js"></div>

  <script>
      var $table = $('#table');
      $(function() {
          $(document).on('focus', 'input[type="text"]', function() {
              $(this).parent().find('label').addClass('active');
          }).on('blur', 'input[type="text"]', function() {
              if ($(this).val() == '') {
                  $(this).parent().find('label').removeClass('active');
              }
          });
          // bootstrap table初始化
          // http://bootstrap-table.wenzhixin.net.cn/zh-cn/documentation/
          $table.bootstrapTable({
              url: '/user/list',
              height: getHeight(),
              striped: true,
              search: true,
              searchOnEnterKey: true,
              showRefresh: true,
              showToggle: true,
              showColumns: true,
              minimumCountColumns: 2,
              showPaginationSwitch: true,
              clickToSelect: true,
              detailView: true,
              detailFormatter: 'detailFormatter',
              pagination: true,
              paginationLoop: false,
              classes: 'table table-hover table-no-bordered',
              sidePagination: 'server',
              //silentSort: false,
              smartDisplay: false,
              idField: 'id',
              sortName: 'id',
              sortOrder: 'desc',
              escape: true,
              searchOnEnterKey: true,
              maintainSelected: true,
              toolbar: '#toolbar',
              queryParamsType : "undefined",
              queryParams: function queryParams(params) {   //设置查询参数
                  var param = {
                      pageNumber: params.pageNumber,
                      pageSize: params.pageSize,
                      searchText:params.searchText,
                      sortName : params.sortName,
                      sortOrder:params.sortOrder
                  };
                  return param;
              },

              columns: [
                  {field: 'state', checkbox: true},
                  {field: 'id', title: '用户ID', sortable: true, halign: 'center',align:'center'},
                  {field: 'username', title: '用户名', sortable: true, halign: 'center',align:'center'},
                  {field: 'realname', title: '真实名字', sortable: true, halign: 'center',align:'center'},
                  {field: 'phone', title: '电话', sortable: true, halign: 'center',align:'center'},
                  {field: 'email', title: '邮件', sortable: true, halign: 'center',align:'center'},
                  {field: 'locked', title: '状态', sortable: true, halign: 'center',align:'center',formatter:'statusFormatter'},
                  {field: 'sex', title: '性别', sortable: true, halign: 'center',align:'center',formatter:'sexFormatter'},
                  {field: 'action', title: '操作', halign: 'center', align: 'center', formatter: 'actionFormatter', events: 'actionEvents', clickToSelect: false}
              ]
          }).on('all.bs.table', function (e, name, args) {
              $('[data-toggle="tooltip"]').tooltip();
              $('[data-toggle="popover"]').popover();
          });
      });
      function statusFormatter(value, row, index) {
          if (value === 1) {
              return '<span class="label label-default">锁定</span>';
          }else if(value === 0){
              return '<span class="label label-success">正常</span>';
          }
          return '<span class="label label-warning">未知</span>';
      }

      function sexFormatter(value, row, index) {
          if (value === 1) {
              return '<span class="label label-success">男</span>';
          }else if(value === 0){
              return '<span class="label label-danger">女</span>';
          }
          return '<span class="label label-warning">未知</span>';
      }

      var formUrl;
      // 新增
      function createAction() {
          formUrl = '/user/create';
          document.getElementById("createForm").reset();
          $('#addModal').modal();
      }

      function doCreate(){
          $.ajax({
              type: 'post',
              url: formUrl,
              data: $('#createForm').serialize(),
              success: function(result) {
                  if (result.status != 0) {
                      failHandler(result);
                  } else {
                      successConfirm();
                      $table.bootstrapTable('refresh');
                      $('#addModal').modal("hide");
                      document.getElementById("createForm").reset();
                  }
              },
              error: errorHandler
          });
      }


      function actionFormatter(value, row, index) {
          return [
              '<a class="edit" href="javascript:void(0)" data-toggle="tooltip" title="编辑"><i class="fa fa-pencil-square-o"></i></a>　',
              '<a class="remove" href="javascript:void(0)" data-toggle="tooltip" title="删除"><i class="fa fa-times-circle"></i></a>'
          ].join('');
      }

      window.actionEvents = {
          'click .edit': function (e, value, row, index) {
              updateAction(row.id);
          },
          'click .remove': function (e, value, row, index) {
              commonDelete(row.id);
          }
      };

      function toUpdate(){
          var rows = $table.bootstrapTable('getSelections');
          if (rows.length != 1) {
              chooseConfirm();
          }else{
              var id = rows[0].id;
              updateAction(id);
          }
      }

      function updateAction(id) {

          formUrl = '/user/update';

              $.ajax({
                  type: 'post',
                  url: '/user/get/' + id,
                  success: function(result) {
                      if (result.status != 0) {
                          failHandler(result);
                      } else {
                          var data = result.data;
                          loadData(data);
                          $('#addModal').modal("show");
                      }
                  },
                  error: errorHandler
              });
      }
      // 删除
      function deleteAction() {
          var rows = $table.bootstrapTable('getSelections');
          if (rows.length == 0) {
              chooseConfirm();
          } else {
              var ids = new Array();
              for (var i in rows) {
                  ids.push(rows[i].id);
              }
              commonDelete(ids.join(","));
          }
      }
      function commonDelete(ids){
          $.confirm({
              type: 'red',
              animationSpeed: 300,
              title: false,
              content: '确认删除该记录吗？',
              buttons: {
                  confirm: {
                      text: '确认',
                      btnClass: 'waves-effect waves-button',
                      action: function () {
                          $.ajax({
                              type: 'post',
                              url: '/user/delete/' + ids,
                              success: function(result) {
                                  if (result.status != 0) {
                                      failHandler(result);
                                  } else {
                                      successConfirm();
                                      $table.bootstrapTable('refresh');
                                  }
                              },
                              error: errorHandler
                          });
                      }
                  },
                  cancel: {
                      text: '取消',
                      btnClass: 'waves-effect waves-button'
                  }
              }
          });
      }
  </script>
  </body>
  </html>